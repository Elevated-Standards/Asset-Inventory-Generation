name: AWS Auto Inventory

on:
    workflow_dispatch:

jobs:
    aws-scan:
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pull-requests: write
        env: 
         CI_COMMIT_MESSAGE: Fetched AWS Assets

        steps:
        # Step 1: Checkout the repository
        - name: Checkout Code
          uses: actions/checkout@v3

        # Step 2: Configure AWS credentials
        - name: Configure AWS credentials for commercial
          uses: aws-actions/configure-aws-credentials@main
          with:
            aws-access-key-id: ${{ secrets.DEVOPS_CORP_AUTOMATION_AWS_ACCESS_KEY }}
            aws-secret-access-key: ${{ secrets.DEVOPS_CORP_AUTOMATION_AWS_SECRET }}
            aws-region: us-east-1

        # Step 3: Debug AWS Credentials (Optional)
        - name: Debug AWS Credentials
          run: aws sts get-caller-identity

        # Step 4: Set up Python
        - name: Set up Python 3.x
          uses: actions/setup-python@v4
          with:
            python-version: '3.10'

        # Step 5: Install System Dependencies
        - name: Install System Dependencies
          run: |
                    sudo apt-get update
                    sudo apt-get install -y python3-dev libatlas-base-dev gfortran libopenblas-dev liblapack-dev build-essential

        # Step 6: Install Python Dependencies
        - name: Install Dependencies
          run: |
            python -m pip install --upgrade pip
            pip install --only-binary=:all: numpy==1.24.4 pandas==2.1.0 boto3==1.28.34 openpyxl==3.1.2

        # Step 7: Run AWS Auto Inventory
        - name: Run AWS Auto Inventory
          run: |
                    python3 scan.py -s config/aws.json -r us-east-1
                    echo "${{ env.CI_COMMIT_MESSAGE }}"

        # Step 8: Commit and Push Results
        - name: Commit and Push Results
          run: |
                    git config --local user.name "GitHub Actions"
                    git config --local user.email "actions@github.com"
                    mkdir -p data/json
                    git add data/json
                    git commit -m "${{ env.CI_COMMIT_MESSAGE }}"
                    git push origin HEAD:${{ github.ref }}

    process-inventory:
        needs: aws-scan
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pull-requests: write
        env: 
         CI_COMMIT_MESSAGE: Processed FedRAMP AWS Inventory

        steps:
            # Step 1: Checkout the repository
            - name: Checkout Code
              uses: actions/checkout@v3

            # Step 2: Set up Python
            - name: Set up Python 3.x
              uses: actions/setup-python@v4
              with:
                    python-version: '3.10'

            # Step 3: Install System Dependencies
            - name: Install System Dependencies
              run: |
                    sudo apt-get update
                    sudo apt-get install -y python3-dev libatlas-base-dev gfortran libopenblas-dev liblapack-dev build-essential

            # Step 4: Install Python Dependencies
            - name: Install Dependencies
              run: |
                    python -m pip install --upgrade pip
                    pip install --only-binary=:all: numpy==1.24.4 pandas==2.1.0 openpyxl==3.1.2

            # Step 5: Run Inventory Processing
            - name: Run Inventory Processing
              run: |
                    python3 main.py
                    echo "${{ env.CI_COMMIT_MESSAGE }}"

            # Step 6: Commit and Push Results
            - name: Commit and Push Results
              run: |
                    git config --local user.name "GitHub Actions"
                    git config --local user.email "actions@github.com"
                    mkdir -p output
                    git add output
                    git commit -m "${{ env.CI_COMMIT_MESSAGE }}"
                    git push origin HEAD:${{ github.ref }}


